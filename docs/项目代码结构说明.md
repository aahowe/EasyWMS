# EasyWMS 项目代码结构说明

**版本：** V1.0  
**更新日期：** 2025-12-22

---

## 文档说明

本文档详细说明 EasyWMS 项目的代码结构、技术架构、数据库设计和开发规范。

**配套文档：** `功能需求说明书.md` - 详细的功能需求和业务流程说明

---

## 目录

1. [项目概览](#1-项目概览)
2. [技术架构](#2-技术架构)
3. [数据库设计](#3-数据库设计)
4. [后端项目结构](#4-后端项目结构)
5. [前端项目结构](#5-前端项目结构)
6. [API接口规范](#6-api接口规范)
7. [开发规范](#7-开发规范)
8. [部署说明](#8-部署说明)

---

## 1. 项目概览

### 1.1 项目信息

| 项目 | 说明 |
| --- | --- |
| 项目名称 | 简易仓库管理系统 (EasyWMS) |
| 技术架构 | Go + Vue 3 + MySQL |
| 开发模式 | 前后端分离 |
| 部署方式 | Docker / 传统部署 |

### 1.2 技术栈

**后端技术栈**
- Go 1.20+
- Gin Web Framework
- GORM (ORM)
- JWT (身份认证)
- Viper (配置管理)
- BCrypt (密码加密)

**前端技术栈**
- Vue 3
- Element Plus
- Vite
- Pinia (状态管理)
- Axios (HTTP客户端)
- ECharts (图表)

**数据库**
- MySQL 8.0
- InnoDB 引擎
- UTF8MB4 字符集

### 1.3 项目目录结构

```
EasyWMS/
├── apps/
│   ├── backend/           # 后端项目（Go）
│   │   ├── cmd/
│   │   │   └── server/
│   │   │       └── main.go    # 应用入口
│   │   ├── internal/
│   │   │   ├── config/        # 配置管理
│   │   │   ├── model/         # 数据模型
│   │   │   ├── dao/           # 数据访问层
│   │   │   ├── service/       # 业务逻辑层
│   │   │   ├── controller/    # 控制器层
│   │   │   ├── middleware/    # 中间件
│   │   │   ├── router/        # 路由配置
│   │   │   └── utils/         # 工具函数
│   │   ├── config/            # 配置文件
│   │   ├── go.mod             # Go模块定义
│   │   └── README.md
│   └── frontend/          # 前端项目（Vue 3）
├── db/                    # 数据库脚本
│   ├── schema.sql         # 建表脚本
│   └── data.sql           # 初始化数据
├── docs/                  # 项目文档
│   ├── 功能需求说明书.md
│   └── 项目代码结构说明.md
└── README.md
```

---

## 2. 技术架构

### 2.1 系统分层架构

系统采用经典的五层架构设计：

**表现层 (Frontend)**
- 职责：用户界面展示、用户交互、前端数据校验
- 技术：Vue 3 + Element Plus
- 特点：基于RBAC模型的动态菜单、响应式布局

**控制层 (Controller)**
- 职责：路由定义、参数解析、请求分发、响应封装
- 技术：Gin Framework
- 特点：RESTful API设计、统一响应格式

**业务逻辑层 (Service)**
- 职责：核心业务逻辑、事务控制、业务规则校验
- 技术：Go语言
- 特点：悲观锁库存扣减、暂估入库处理、盘点差异计算

**数据访问层 (DAO)**
- 职责：数据库CRUD操作、SQL执行
- 技术：GORM
- 特点：接口抽象、支持事务

**数据模型层 (Model)**
- 职责：数据结构定义、ORM映射
- 技术：GORM Struct Tags
- 特点：与数据库表一一对应

---

## 3. 数据库设计

### 3.1 数据库概览

**数据库名称：** easywms  
**字符集：** utf8mb4  
**排序规则：** utf8mb4_unicode_ci  
**存储引擎：** InnoDB  
**脚本位置：**
- 建表脚本：`db/schema.sql`
- 初始化数据：`db/data.sql`

### 3.2 表结构概览

系统共14张表，分为基础数据表和业务单据表两大类。

**基础数据表（5张）**
1. `sys_user` - 系统用户表
2. `base_department` - 部门表
3. `base_supplier` - 供应商表
4. `base_category` - 物资分类表
5. `base_product` - 物资档案表

**业务单据表（9张）**
6. `biz_procurement` - 采购订单主表
7. `biz_procurement_item` - 采购明细表
8. `biz_inbound` - 入库单主表
9. `biz_inbound_item` - 入库明细表
10. `biz_outbound` - 出库主表
11. `biz_outbound_item` - 领用明细表
12. `biz_stock_log` - 库存流水表
13. `biz_inventory_check` - 盘点主表
14. `biz_inventory_check_item` - 盘点差异表

### 3.3 核心表设计

#### sys_user - 系统用户表

存储所有登录账号、密码及角色身份。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | BIGINT | 主键、自增 |
| username | VARCHAR(64) | 登录账号（唯一） |
| password | VARCHAR(128) | 密码（BCrypt加密） |
| real_name | VARCHAR(64) | 真实姓名 |
| dept_id | BIGINT | 部门ID（外键） |
| role_code | VARCHAR(20) | 角色编码（ADMIN/BUYER/W_MGR/STAFF） |
| status | TINYINT | 状态（1-启用, 0-禁用） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### base_product - 物资档案表

系统的核心资产表，定义物资规格并存储实时库存。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | BIGINT | 主键、自增 |
| category_id | BIGINT | 所属分类ID（外键） |
| sku_code | VARCHAR(64) | SKU编码（唯一） |
| name | VARCHAR(128) | 物资名称 |
| specification | VARCHAR(128) | 规格型号 |
| unit | VARCHAR(20) | 计量单位 |
| stock_qty | DECIMAL(14,4) | 实时库存（悲观锁扣减对象） |
| alert_threshold | DECIMAL(14,4) | 预警阈值 |
| status | TINYINT | 状态（1-启用, 0-停用） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### biz_stock_log - 库存流水表

系统的"总账本"，不可篡改地记录每一次库存变动。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | BIGINT | 主键、自增 |
| product_id | BIGINT | 物资ID（外键） |
| type | VARCHAR(10) | 变动类型（IN/OUT/ADJUST） |
| change_qty | DECIMAL(14,4) | 变动数量（正数增、负数减） |
| snapshot_qty | DECIMAL(14,4) | 变动后的库存快照 |
| related_no | VARCHAR(32) | 关联单号 |
| operator_id | BIGINT | 操作人ID（外键） |
| created_at | DATETIME | 发生时间 |

### 3.4 外键关系图

```
sys_user.dept_id → base_department.id
base_product.category_id → base_category.id
biz_procurement.applicant_id → sys_user.id
biz_procurement.supplier_id → base_supplier.id
biz_inbound.source_id → biz_procurement.id
biz_outbound.applicant_id → sys_user.id
biz_outbound.dept_id → base_department.id
biz_stock_log.product_id → base_product.id
```

### 3.5 初始化数据

`db/data.sql` 包含以下测试数据：

- **7个部门**：总经办、研发部、采购部、仓储部、行政部、前端组、后端组
- **5个用户**：admin（管理员）、buyer01（采购）、warehouse01（仓管）、staff01/02（员工）
- **5个供应商**：晨光文具、得力办公、联想电子、华为技术、3M中国
- **8个物资分类**：办公用品、电子设备、劳保用品及其子分类
- **10个物资档案**：中性笔、铅笔、A4纸、笔记本电脑、路由器、口罩等
- **10条期初库存流水**：对应10个物资的初始库存

**默认密码**：所有用户密码均为 `123456`（BCrypt加密）

---

## 4. 后端项目结构

### 4.1 目录结构详解

```
apps/backend/
├── cmd/
│   └── server/
│       └── main.go              # 应用入口，初始化配置和路由
├── internal/
│   ├── config/
│   │   └── config.go            # 配置结构定义和加载
│   ├── model/                   # 数据模型（GORM实体）
│   │   ├── user.go              # 用户模型
│   │   ├── department.go        # 部门模型
│   │   ├── product.go           # 物资模型
│   │   ├── supplier.go          # 供应商模型
│   │   ├── procurement.go       # 采购模型
│   │   ├── inbound.go           # 入库模型
│   │   ├── outbound.go          # 出库模型
│   │   ├── stock_log.go         # 库存流水模型
│   │   └── inventory_check.go   # 盘点模型
│   ├── dao/                     # 数据访问层
│   │   ├── user/
│   │   │   └── user_dao.go      # 用户数据操作
│   │   ├── basic/
│   │   │   ├── product_dao.go   # 物资数据操作
│   │   │   └── supplier_dao.go  # 供应商数据操作
│   │   ├── procure/
│   │   │   └── procure_dao.go   # 采购数据操作
│   │   ├── stock/
│   │   │   ├── stock_in_dao.go  # 入库数据操作
│   │   │   ├── stock_out_dao.go # 出库数据操作
│   │   │   └── stock_log_dao.go # 流水数据操作
│   │   └── inventory/
│   │       └── check_dao.go     # 盘点数据操作
│   ├── service/                 # 业务逻辑层
│   │   ├── basic/
│   │   │   └── basic_service.go # 基础数据业务逻辑
│   │   ├── procure/
│   │   │   └── procure_service.go # 采购业务逻辑
│   │   ├── stock/
│   │   │   ├── inbound_service.go  # 入库业务逻辑
│   │   │   └── outbound_service.go # 出库业务逻辑
│   │   └── inventory/
│   │       └── inventory_service.go # 统计盘点业务逻辑
│   ├── controller/              # 控制器层
│   │   ├── user_controller.go
│   │   ├── product_controller.go
│   │   ├── procurement_controller.go
│   │   ├── inbound_controller.go
│   │   ├── outbound_controller.go
│   │   └── inventory_controller.go
│   ├── middleware/              # 中间件
│   │   ├── auth.go              # JWT认证中间件
│   │   ├── cors.go              # CORS跨域中间件
│   │   └── logger.go            # 日志中间件
│   ├── router/                  # 路由配置
│   │   └── router.go            # 路由注册
│   └── utils/                   # 工具函数
│       ├── response.go          # 统一响应格式
│       ├── jwt.go               # JWT工具
│       └── password.go          # 密码加密工具
├── config/                      # 配置文件
│   ├── config.yaml              # 实际配置（不提交）
│   └── config.example.yaml      # 配置示例
├── go.mod                       # Go模块定义
├── .gitignore                   # Git忽略文件
└── README.md                    # 项目说明
```

### 4.2 核心组件说明

#### 4.2.1 配置管理 (config)

使用 Viper 加载 YAML 配置文件，支持：
- 服务器配置（端口、运行模式）
- 数据库配置（连接信息、连接池）
- JWT配置（密钥、过期时间）
- 日志配置（级别、文件路径）
- CORS配置（允许的域名、方法、头部）

#### 4.2.2 数据模型 (model)

使用 GORM 定义数据模型，特点：
- 结构体标签定义字段类型和约束
- 自动映射到数据库表
- 支持关联查询
- 自动维护创建和更新时间

示例：
```go
type User struct {
    ID        int64     `gorm:"primaryKey;autoIncrement" json:"id"`
    Username  string    `gorm:"type:varchar(64);uniqueIndex" json:"username"`
    Password  string    `gorm:"type:varchar(128)" json:"-"`
    RealName  string    `gorm:"type:varchar(64)" json:"real_name"`
    DeptID    int64     `gorm:"index" json:"dept_id"`
    RoleCode  string    `gorm:"type:varchar(20);index" json:"role_code"`
    Status    int8      `gorm:"type:tinyint;default:1" json:"status"`
    CreatedAt time.Time `gorm:"autoCreateTime" json:"created_at"`
    UpdatedAt time.Time `gorm:"autoUpdateTime" json:"updated_at"`
}
```

#### 4.2.3 数据访问层 (dao)

封装数据库操作，提供标准的CRUD接口：
- 接口定义：定义数据操作接口
- 实现类：实现具体的数据库操作
- 事务支持：支持事务操作
- 错误处理：统一的错误处理

#### 4.2.4 业务逻辑层 (service)

实现核心业务逻辑：
- 业务规则校验
- 事务控制
- 调用DAO层进行数据操作
- 返回处理结果

关键业务逻辑：
- **库存扣减**：使用悲观锁（SELECT ... FOR UPDATE）防止并发超卖
- **暂估入库**：标记财务状态为"未结算"
- **盘点调整**：自动计算盈亏并生成调整记录

#### 4.2.5 控制器层 (controller)

处理HTTP请求：
- 参数解析和校验
- 调用Service层处理业务
- 封装响应结果
- 错误处理

#### 4.2.6 中间件 (middleware)

**JWT认证中间件**
- 验证Authorization头中的JWT令牌
- 解析用户信息并存入上下文
- 拦截未授权请求

**CORS中间件**
- 处理跨域请求
- 设置CORS响应头
- 处理OPTIONS预检请求

**日志中间件**
- 记录请求信息（方法、路径、IP）
- 记录响应状态和耗时
- 便于问题排查

#### 4.2.7 工具函数 (utils)

**统一响应格式**
```go
type Response struct {
    Code    int         `json:"code"`
    Message string      `json:"message"`
    Data    interface{} `json:"data,omitempty"`
}
```

**JWT工具**
- GenerateToken：生成JWT令牌
- ParseToken：解析JWT令牌

**密码工具**
- HashPassword：BCrypt加密密码
- CheckPassword：验证密码

### 4.3 已实现功能

✅ 项目结构搭建  
✅ 配置管理（Viper）  
✅ 路由框架（Gin）  
✅ JWT认证中间件  
✅ CORS跨域中间件  
✅ 日志中间件  
✅ 统一响应格式  
✅ 密码加密工具  
✅ 基础数据模型（User, Department, Product）

### 4.4 待实现功能

⏳ 数据库连接初始化  
⏳ 完整的Model定义  
⏳ DAO层实现  
⏳ Service层业务逻辑  
⏳ Controller层接口实现  
⏳ 完整的CRUD操作  
⏳ 采购管理业务流程  
⏳ 入库管理业务流程  
⏳ 出库管理业务流程  
⏳ 统计与盘点功能

---

## 5. 前端项目结构

### 5.1 项目位置

`apps/frontend` - Vue 3 前端项目

### 5.2 技术栈

- Vue 3 (Composition API)
- Ant Design Vue (UI组件库)
- Vite (构建工具)
- Pinia (状态管理)
- Vue Router (路由管理)
- Axios (HTTP客户端)
- ECharts (图表库)

### 5.3 目录结构

```
apps/frontend/
├── src/
│   ├── api/              # API接口封装
│   ├── assets/           # 静态资源
│   ├── components/       # 公共组件
│   ├── layouts/          # 布局组件
│   ├── router/           # 路由配置
│   ├── stores/           # Pinia状态管理
│   ├── utils/            # 工具函数
│   ├── views/            # 页面组件
│   ├── App.vue           # 根组件
│   └── main.js           # 入口文件
├── public/               # 公共资源
├── .env.development      # 开发环境配置
├── .env.production       # 生产环境配置
├── vite.config.js        # Vite配置
└── package.json          # 依赖配置
```

### 5.4 核心功能模块

**基础数据管理**
- 物资档案管理
- 供应商管理
- 部门管理
- 用户管理

**采购管理**
- 采购申请
- 采购审核
- 采购订单

**入库管理**
- 到货验收
- 正常入库
- 暂估入库

**出库管理**
- 领用申请
- 出库审核
- 出库执行

**统计与盘点**
- 库存查询
- 统计报表
- 库存盘点

---

## 6. API接口规范

### 6.1 接口设计原则

- RESTful API设计风格
- 统一的响应格式
- 使用HTTP状态码
- JWT令牌认证
- 版本控制（/api/v1）

### 6.2 统一响应格式

```json
{
  "code": 0,
  "message": "success",
  "data": {}
}
```

**code说明：**
- 0：成功
- 400：请求参数错误
- 401：未授权
- 403：无权限
- 404：资源不存在
- 500：服务器错误

### 6.3 接口列表

#### 认证接口

| 方法 | 路径 | 说明 | 认证 |
| --- | --- | --- | --- |
| POST | /api/auth/login | 用户登录 | 否 |
| POST | /api/auth/logout | 用户登出 | 是 |

#### 基础数据接口

| 方法 | 路径 | 说明 | 认证 |
| --- | --- | --- | --- |
| GET | /api/products | 获取物资列表 | 是 |
| POST | /api/products | 创建物资 | 是 |
| PUT | /api/products/:id | 更新物资 | 是 |
| DELETE | /api/products/:id | 删除物资 | 是 |
| GET | /api/suppliers | 获取供应商列表 | 是 |
| POST | /api/suppliers | 创建供应商 | 是 |

#### 采购管理接口

| 方法 | 路径 | 说明 | 认证 |
| --- | --- | --- | --- |
| GET | /api/procurements | 获取采购单列表 | 是 |
| POST | /api/procurements | 创建采购申请 | 是 |
| PUT | /api/procurements/:id/approve | 审批采购申请 | 是 |
| POST | /api/procurements/:id/order | 生成采购订单 | 是 |

#### 入库管理接口

| 方法 | 路径 | 说明 | 认证 |
| --- | --- | --- | --- |
| GET | /api/inbounds | 获取入库单列表 | 是 |
| POST | /api/inbounds | 创建入库单 | 是 |
| PUT | /api/inbounds/:id/confirm | 确认入库 | 是 |

#### 出库管理接口

| 方法 | 路径 | 说明 | 认证 |
| --- | --- | --- | --- |
| GET | /api/outbounds | 获取出库单列表 | 是 |
| POST | /api/outbounds | 创建领用申请 | 是 |
| PUT | /api/outbounds/:id/approve | 审批领用申请 | 是 |
| PUT | /api/outbounds/:id/execute | 执行出库 | 是 |

#### 统计与盘点接口

| 方法 | 路径 | 说明 | 认证 |
| --- | --- | --- | --- |
| GET | /api/inventory/stock | 查询库存 | 是 |
| GET | /api/inventory/reports | 统计报表 | 是 |
| POST | /api/inventory/checks | 创建盘点任务 | 是 |
| PUT | /api/inventory/checks/:id/adjust | 盘点调整 | 是 |

---

## 7. 开发规范

### 7.1 代码规范

**Go代码规范**
- 遵循 Go 官方代码规范
- 使用 `gofmt` 格式化代码
- 使用 `golint` 进行代码检查
- 变量命名使用驼峰命名法
- 常量使用全大写加下划线

**Vue代码规范**
- 遵循 Vue 3 官方风格指南
- 组件名使用 PascalCase
- 使用 Composition API
- Props 定义使用对象形式
- 使用 ESLint 进行代码检查

### 7.2 Git提交规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**type类型：**
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式调整
- refactor: 代码重构
- test: 测试相关
- chore: 构建/工具链相关

**示例：**
```
feat(product): 添加物资档案管理功能

- 实现物资列表查询
- 实现物资新增功能
- 实现物资编辑功能

Closes #123
```

### 7.3 数据库规范

- 表名使用小写加下划线
- 字段名使用小写加下划线
- 主键统一使用 `id`
- 时间字段统一使用 `created_at` 和 `updated_at`
- 外键字段命名：`关联表_id`
- 索引命名：`idx_字段名` 或 `uk_字段名`（唯一索引）

### 7.4 注释规范

**Go注释**
```go
// GetUserByID 根据ID获取用户信息
// @param id 用户ID
// @return user 用户信息
// @return error 错误信息
func GetUserByID(id int64) (*User, error) {
    // 实现代码
}
```

**Vue注释**
```vue
<script setup>
/**
 * 获取物资列表
 * @param {Object} params - 查询参数
 * @returns {Promise} 物资列表数据
 */
const getProductList = async (params) => {
  // 实现代码
}
</script>
```

---

## 8. 部署说明

### 8.1 开发环境部署

**1. 初始化数据库**
```bash
mysql -u root -p < db/schema.sql
mysql -u root -p < db/data.sql
```

**2. 配置后端**
```bash
cd backend
cp config/config.example.yaml config/config.yaml
# 编辑 config.yaml，配置数据库连接信息
go mod download
go run cmd/server/main.go
```

**3. 配置前端**
```bash
cd apps/frontend
pnpm install
pnpm dev
```

### 8.2 生产环境部署

**使用Docker部署（推荐）**

1. 构建后端镜像
2. 构建前端镜像
3. 使用 docker-compose 编排服务
4. 配置 Nginx 反向代理

**传统部署**

1. 编译Go程序：`go build -o easywms cmd/server/main.go`
2. 构建前端：`pnpm build`
3. 配置Nginx
4. 使用systemd管理后端服务

### 8.3 注意事项

1. **数据库字符集**：必须使用 `utf8mb4` 以支持完整的Unicode字符
2. **密码加密**：使用 BCrypt 算法，成本因子为默认值（10）
3. **并发控制**：库存扣减使用悲观锁（SELECT ... FOR UPDATE）
4. **事务处理**：入库、出库操作必须在事务中执行
5. **外键约束**：已添加外键约束，删除操作需注意级联关系
6. **JWT密钥**：生产环境必须修改JWT密钥
7. **CORS配置**：生产环境需配置正确的允许域名

---

## 9. 附录

### 9.1 常见问题

**Q: 如何重置数据库？**
A: 删除数据库后重新执行 schema.sql 和 data.sql

**Q: 如何修改默认端口？**
A: 修改 config/config.yaml 中的 server.port 配置

**Q: 如何添加新的角色？**
A: 在 sys_user 表的 role_code 字段中添加新的角色代码，并在前端路由守卫中配置权限

### 9.2 参考资料

- [Go官方文档](https://golang.org/doc/)
- [Gin框架文档](https://gin-gonic.com/docs/)
- [GORM文档](https://gorm.io/docs/)
- [Vue 3文档](https://vuejs.org/)
- [Element Plus文档](https://element-plus.org/)

---

**文档结束**
